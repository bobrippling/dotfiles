loadagent(){
	proc_name="$1"
	agent_file="$2"

	if pgrep -x "$proc_name" > /dev/null
	then
		if [ -f "$agent_file" ]
		then
			. "$agent_file"
			return 0
		else
			echo >&2 "environ: no such file \"$agent_file\""
			return 1
		fi
	else
		echo >&2 "environ: \"$proc_name\" not running"
		return 1
	fi
}

if test -z "$SSH_AUTH_SOCK" && loadagent ssh-agent "$HOME/.ssh/env_agent"
then
	nssh=$(ssh-add -l | grep '^[0-9]' | wc -l)
	if test $nssh -eq 0
	then echo >&2 "environ: no ssh identities"
	fi
fi

loadagent gpg-agent "$HOME/.ssh/gpg_env_agent"

#. "$HOME/bin/dyld_insert.sh"

init_nvm(){
	export NVM_DIR="$HOME/.nvm"
	. "$(brew --prefix nvm)/nvm.sh"
}

if [[ -n "$PS1" ]] && [[ -t 0 ]] && [[ -t 1 ]] && [[ -t 2 ]]
then
	stty dsusp undef

	export GPG_TTY=$(tty)
	export PINENTRY_USER_DATA="USE_CURSES=0"

	case "$TERM" in
		rxvt-unicode-256color|tmux-256color)
			printf >&2 '\x1b[31mbogus term %s, resetting to' "$TERM"
			TERM=xterm-256color
			printf >&2 ' \x1b[1;31m%s\x1b[0;0m\n' "$TERM"
			;;
	esac

	~/bin/tips
fi
